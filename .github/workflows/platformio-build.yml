name: PlatformIO Build

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.environment }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment:
          - lilygo-t5-s3
          - m5-papers3

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio/.cache
            ~/.platformio/packages
            ~/.platformio/platforms
          key: ${{ runner.os }}-pio-${{ hashFiles('platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Generate Icons Header
        run: |
          pip install pillow
          python generate-icons.py

      - name: Generate CI Config Stub
        run: |
          if [ ! -f src/config_remote.cpp ]; then
            python -c 'from pathlib import Path; Path("src/config_remote.cpp").write_text("""#include \"config_remote.h\"\n\nvoid configure_remote(Configuration* config, EntityStore* store, Screen* screen) {\n  (void)store;\n  config->wifi_ssid = \"ci\";\n  config->wifi_password = \"ci\";\n  config->home_assistant_url = \"wss://example.invalid/api/websocket\";\n  config->home_assistant_token = \"ci\";\n  config->root_ca = ISRG_ROOT_X1;\n  screen->widget_count = 0;\n}\n""")'
          fi

      - name: Build
        run: pio run -e ${{ matrix.environment }}
